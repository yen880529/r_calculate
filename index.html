<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"> 
    <title>R角座標計算</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .button-row {
            margin: 10px 0;
            display: flex;
            gap: 15px; /* 設定按鈕之間的間距 */
            justify-content: center; /* 使按鈕居中對齊 */
        }

        button {
            padding: 12px;
            width: 100px;
            background-color: #007bff;
            border: 1px solid #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.active {
            background-color: #28a745;
            border-color: #28a745;
        }

        .form-group {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            justify-content: center;
            align-items: center;
        }

        .form-group label {
            font-size: 16px;
            color: #333;
        }

        .form-group input {
            padding: 10px;
            width: 120px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
            margin-right: 5px;
        }

        .form-group input:focus {
            border-color: #007bff;
            outline: none;
        }

        #result {
            margin-top: 20px;
            font-size: 1.2em;
            color: #555;
            font-weight: bold;
        }

        .section-title {
            font-size: 18px;
            color: #333;
            margin-top: 20px;
        }

        canvas {
            width: 200px; /* 或其他大小 */
            height: 200px;
            margin-top: 30px;
            background: white;
            border: 1px solid #ddd;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h1>R角座標計算</h1>

    <!-- Machine Selection -->
    <p class="section-title">機台選擇</p>
    <div class="button-row">
        <button onclick="selectMachine('T', this)">T</button>
        <button onclick="selectMachine('L', this)">L</button>
    </div>

    <!-- Direction Buttons -->
    <p class="section-title">刀尖方向</p>
    <div class="button-row" id="direction-buttons">
        <!-- Buttons will be dynamically updated here -->
    </div>

    <!-- Input Fields -->
    <p class="section-title">輸入數字：</p>
    
    <div class="form-group">
        <label>座標1</label>
        <input type="number" id="x1" placeholder="X">
        <input type="number" id="z1" placeholder="Z">
    </div>

    <div class="form-group">
        <label>座標2</label>
        <input type="number" id="x2" placeholder="X">
        <input type="number" id="z2" placeholder="Z">
    </div>

    <div class="form-group">
        <label>座標3</label>
        <input type="number" id="x3" placeholder="X">
        <input type="number" id="z3" placeholder="Z">
    </div>

    <div class="form-group">
        <input type="number" id="r" placeholder="R角">
    </div>
    <div class="form-group">
        <input type="number" id="radius" placeholder="刀尖R">
    </div>
    <div class="form-group">
        <input type="number" id="reserved" placeholder="預留量">
    </div>

    <!-- Calculate Button -->
    <div class="button-row">
        <button onclick="calculate()">計算</button>
    </div>

    <!-- Result Display -->
    <div id="test">結果：--</div>
    <div id="draw">結果：--</div>

    <!-- Chart Display -->
    <div >
        <canvas id="coordinateChart" style="width: 300%; height: 300%;"></canvas>
    </div>
    

    <script>
        let selectedMachine = null;
        let selectedDirection = null;

        function selectMachine(machine, button) {
            selectedMachine = machine;
            highlightButton(button, 'machine');
            updateDirectionButtons();
            updateResult();
        }

        function selectDirection(direction, button) {
            selectedDirection = direction;
            highlightButton(button, 'direction');
            updateResult();
        }

        function highlightButton(button, group) {
            const buttonGroup = document.querySelectorAll(`.button-row button`);
            buttonGroup.forEach(btn => {
                if (btn.parentNode === button.parentNode) {
                    btn.classList.remove('active');
                }
            });
            button.classList.add('active');
        }

        function updateDirectionButtons() {
            const directionButtonsContainer = document.getElementById('direction-buttons');
            directionButtonsContainer.innerHTML = ''; // Clear existing buttons

            if (selectedMachine === 'T') {
                const leftButton = document.createElement('button');
                leftButton.textContent = '左';
                leftButton.onclick = () => selectDirection('left', leftButton);
                directionButtonsContainer.appendChild(leftButton);

                const rightButton = document.createElement('button');
                rightButton.textContent = '右';
                rightButton.onclick = () => selectDirection('right', rightButton);
                directionButtonsContainer.appendChild(rightButton);
            } else if (selectedMachine === 'L') {
                const upButton = document.createElement('button');
                upButton.textContent = '上';
                upButton.onclick = () => selectDirection('up', upButton);
                directionButtonsContainer.appendChild(upButton);

                const downButton = document.createElement('button');
                downButton.textContent = '下';
                downButton.onclick = () => selectDirection('down', downButton);
                directionButtonsContainer.appendChild(downButton);
            }
        }

        let chart = null;

        function initializeChart() {
            const ctx = document.getElementById('coordinateChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                    {
                        label: '圖面',
                        data: [], // 用於儲存輸入的座標點
                        backgroundColor: 'rgba(54, 162, 235, 0.8)', // 點的顏色
                        borderColor: 'rgba(54, 162, 235, 1)', // 線的顏色
                        borderWidth: 2, // 線的粗細
                        fill: false, // 不填充點之間的區域
                        lineTension: 0, // 使線條不會有彎曲
                        showLine: true, // 顯示線
                    },
                    {
                        label: '刀具路徑',
                        data: [], // 用於儲存計算結果的座標點
                        backgroundColor: 'rgba(255, 99, 132, 0.8)', // 點的顏色
                        borderColor: 'rgba(255, 99, 132, 1)', // 線的顏色
                        borderWidth: 2, // 線的粗細
                        fill: false, // 不填充點之間的區域
                        lineTension: 0, // 使線條不會有彎曲
                        showLine: true, // 顯示線
                    },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'X 座標',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Z 座標',
                            },
                        },
                    },
                },
            });
        }

        function updateChart(inputPoints, arcPoints) {
            chart.data.datasets[0].data = inputPoints; // 更新輸入座標
            chart.data.datasets[1].data = arcPoints; // 更新圓弧計算結果
            chart.update();
        }

        function calculate() {
            const x1 = parseFloat(document.getElementById('x1').value) / 2;
            const z1 = parseFloat(document.getElementById('z1').value);
            const x2 = parseFloat(document.getElementById('x2').value) / 2;
            const z2 = parseFloat(document.getElementById('z2').value);
            const x3 = parseFloat(document.getElementById('x3').value) / 2;
            const z3 = parseFloat(document.getElementById('z3').value);

            const r = parseFloat(document.getElementById('r').value);
            const reserved = parseFloat(document.getElementById('reserved').value);
            const radius = parseFloat(document.getElementById('radius').value);

            if (!isNaN(x1) && !isNaN(z1) && !isNaN(x2) && !isNaN(z2) && !isNaN(x3) && !isNaN(z3)) {
                const inputPoints = [
                    { x: x1, y: z1 },
                    { x: x2, y: z2 },
                    { x: x3, y: z3 },
                ];

                if (selectedMachine && selectedDirection) {
                    const AB = Math.sqrt((x2 - x1) ** 2 + (z2 - z1) ** 2);
                    const BC = Math.sqrt((x3 - x2) ** 2 + (z3 - z2) ** 2);

                    const AB_rad = Math.asin((z2 - z1) / AB);
                    const AB_angles = AB_rad * (180 / Math.PI);

                    const BC_rad = Math.acos((z3 - z2) / BC);
                    const BC_angles = BC_rad * (180 / Math.PI);

                    const R_angles = Math.abs((90 - AB_angles - BC_angles) / 2);
                    const RR = r * Math.tan(R_angles * Math.PI / 180);

                    const R1_X = RR * Math.cos(AB_angles * Math.PI / 180);
                    const R1_Z = RR * Math.sin(AB_angles * Math.PI / 180);

                    const R2_X = RR * Math.sin(BC_angles * Math.PI / 180);
                    const R2_Z = RR * Math.cos(BC_angles * Math.PI / 180);

                    const P1_X = (reserved + radius) * Math.sin(AB_angles * Math.PI / 180);
                    const P1_Z = (reserved + radius) * Math.cos(AB_angles * Math.PI / 180);

                    const P2_X = (reserved + radius) * Math.cos(BC_angles * Math.PI / 180);
                    const P2_Z = (reserved + radius) * Math.sin(BC_angles * Math.PI / 180);

                    let R_first_X, R_first_Z, R_finish_X, R_finish_Z;
                    let center_X = 0, center_Z = 0; // Default values

                    if (selectedMachine === 'T' && selectedDirection === 'left') {
                        R_first_X = (x2 - R1_X - P1_X - radius) * 2;
                        R_first_Z = z2 - R1_Z + P1_Z - radius;
                        R_finish_X = (x2 + R2_X - P2_X - radius) * 2;
                        R_finish_Z = z2 + R2_Z + P2_Z - radius;
                        const center_XZ = Math.sqrt(r ** 2 + RR ** 2);
                        center_X = x2 - center_XZ * Math.sin((AB_angles + R_angles) * Math.PI / 180);
                        center_Z = z2 - center_XZ * Math.cos((AB_angles + R_angles) * Math.PI / 180);
                    } else if (selectedMachine === 'T' && selectedDirection === 'right') {
                        R_first_X = (x2 + R1_X + P1_X + radius) * 2;
                        R_first_Z = z2 - R1_Z + P1_Z - radius;
                        R_finish_X = (x2 - R2_X + P2_X + radius) * 2;
                        R_finish_Z = z2 + R2_Z + P2_Z - radius;
                        const center_XZ = Math.sqrt(r ** 2 + RR ** 2);
                        center_X = x2 - center_XZ * Math.sin((AB_angles + R_angles) * Math.PI / 180)+reserved;
                        center_Z = z2 - center_XZ * Math.cos((AB_angles + R_angles) * Math.PI / 180);
                    } else if (selectedMachine === 'L' && selectedDirection === 'up') {
                        R_first_X = (x2 + R1_X + P1_X + radius) * 2;
                        R_first_Z = z2 - R1_Z + P1_Z - radius;
                        R_finish_X = (x2 - R2_X + P2_X + radius) * 2;
                        R_finish_Z = z2 + R2_Z + P2_Z - radius;
                        const center_XZ = Math.sqrt(r ** 2 + RR ** 2);
                        center_X = x2 - center_XZ * Math.sin((AB_angles + R_angles) * Math.PI / 180);
                        center_Z = z2 - center_XZ * Math.cos((AB_angles + R_angles) * Math.PI / 180);
                    } else if (selectedMachine === 'L' && selectedDirection === 'down') {
                        R_first_X = (x2 + R1_X - P1_X - radius) * 2;
                        R_first_Z = z2 - R1_Z + P1_Z - radius;
                        R_finish_X = (x2 - R2_X - P2_X - radius) * 2;
                        R_finish_Z = z2 + R2_Z - P2_Z - radius;
                        const center_XZ = Math.sqrt(r ** 2 + RR ** 2);
                        center_X = x2 - center_XZ * Math.sin((AB_angles + R_angles) * Math.PI / 180);
                        center_Z = z2 - center_XZ * Math.cos((AB_angles + R_angles) * Math.PI / 180);
                    } else {
                        document.getElementById('test').textContent = '未知的條件';
                        return;
                    }

                    // 確保起點和終點圓弧正確
                    const startAngle = Math.atan2(R_first_Z - center_Z, (R_first_X / 2) - center_X);
                    const endAngle = Math.atan2(R_finish_Z - center_Z, (R_finish_X / 2) - center_X);

                    // 使用 r 來繪製圓弧
                    const arcPoints = [];
                    const numPoints = 100; // 點的數量

                    const angleStep = (endAngle - startAngle) / numPoints;

                    for (let i = 0; i <= numPoints; i++) {
                        const angle = startAngle + i * angleStep;
                        const arcX = center_X + (r + reserved) * Math.cos(angle);
                        const arcZ = center_Z + (r + reserved) * Math.sin(angle);
                        arcPoints.push({ x: arcX, y: arcZ });
                    }

                    // Update chart
                    updateChart(inputPoints, arcPoints);

                    // Display the result
                    document.getElementById('test').innerHTML = `
                        結果：<br>
                        R角起點: ${R_first_X.toFixed(2)}, ${R_first_Z.toFixed(2)}<br>
                        R角終點: ${R_finish_X.toFixed(2)}, ${R_finish_Z.toFixed(2)}<br>
                        RR: ${RR.toFixed(2)}<br>
                        R角中心: ${center_X.toFixed(2)}, ${center_Z.toFixed(2)}
                    `;
                } else {
                    document.getElementById('test').textContent = '請選擇機台和方向';
                }
            } else {
                document.getElementById('draw').textContent = '請輸入完整的座標';
            }
        }

        initializeChart();
    </script>
</body>
</html>
